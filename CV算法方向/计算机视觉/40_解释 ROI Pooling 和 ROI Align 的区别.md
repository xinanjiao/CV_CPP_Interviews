## 问题

ROI Pooling 和 ROI Align 的区别是什么

## ROI Pooling 和 ROI Align 是什么

如果你对目标检测网络 Faster R-CNN 和实例分割网络 Mask R-CNN 网络比较熟悉的话，那你应该也对这个话题非常熟悉。

在区域建议网络 RPN 得到候选框 ROI 之后，需要提取该 ROI 中的固定数目的特征（例如Faster R-CNN中的 7*7 ）输入到后面的分类网络以及边界回归网络的全连接层中。Faster R-CNN中使用的方法是 ROI Pooling，而对于像素位置精细度要求更高的 Mask R-CNN 对 ROI Pooling 进行改进，变成 ROI Align。

**ROI Pooling和ROIAlign最大的区别是：前者使用了两次量化操作，而后者并没有采用量化操作，使用了双线性插值算法，具体的解释如下所示。**

## ROI Pooling 技术细节

<img src="https://i.loli.net/2020/06/21/Ik9TYm6tnd4Uzgs.png" alt="img" style="zoom:200%;" />

如上图所示，为了得到固定大小（7X7）的feature map，我们需要做两次量化操作：

1. 图像坐标 — feature map坐标
2. feature map坐标 — ROI feature坐标。

我们来说一下具体的细节，如图我们输入的是一张800x800的图像，在图像中有两个目标（猫和狗），狗的BB大小为665x665，经过VGG16网络后，我们可以获得对应的feature map，如果我们对卷积层进行Padding操作，我们的图片经过卷积层后保持原来的大小，但是由于池化层的存在，我们最终获得feature map 会比原图缩小一定的比例，这和Pooling层的个数和大小有关。在该VGG16中，我们使用了5个池化操作，每个池化操作都是2Pooling，因此我们最终获得feature map的大小为800/32 x 800/32 = 25x25（是整数），但是将狗的BB对应到feature map上面，我们得到的结果是665/32 x 665/32 = 20.78 x 20.78，结果是浮点数，含有小数，但是我们的像素值可没有小数，那么作者就对其进行了量化操作（即取整操作），即其结果变为20 x 20，在这里引入了第一次的量化误差；然而我们的feature map中有不同大小的ROI，但是我们后面的网络却要求我们有固定的输入，因此，我们需要将不同大小的ROI转化为固定的ROI feature，在这里使用的是7x7的ROI feature，那么我们需要将20 x 20的ROI映射成7 x 7的ROI feature，其结果是 20 /7 x 20/7 = 2.86 x 2.86，同样是浮点数，含有小数点，我们采取同样的操作对其进行取整吧，在这里引入了第二次量化误差。其实，这里引入的误差会导致图像中的像素和特征中的像素的偏差，即将feature空间的ROI对应到原图上面会出现很大的偏差。原因如下：比如用我们第二次引入的误差来分析，本来是2,86，我们将其量化为2，这期间引入了0.86的误差，看起来是一个很小的误差呀，但是你要记得这是在feature空间，我们的feature空间和图像空间是有比例关系的，在这里是1:32，那么对应到原图上面的差距就是0.86 x 32 = 27.52。这个差距不小吧，这还是仅仅考虑了第二次的量化误差。这会大大影响整个检测算法的性能，因此是一个严重的问题。

## ROI Align 技术细节

![img](https://i.loli.net/2020/06/21/r3tGoY8P7LeCsUl.png)

如上图所示，为了得到为了得到固定大小（7X7）的feature map，ROIAlign技术并没有使用量化操作，即我们不想引入量化误差，比如665 / 32 = 20.78，我们就用20.78，不用什么20来替代它，比如20.78 / 7 = 2.97，我们就用2.97，而不用2来代替它。这就是ROIAlign的初衷。那么我们如何处理这些浮点数呢，我们的解决思路是使用“双线性插值”算法。双线性插值是一种比较好的图像缩放算法，它充分的利用了原图中虚拟点（比如20.56这个浮点数，像素位置都是整数值，没有浮点值）四周的四个真实存在的像素值来共同决定目标图中的一个像素值，即可以将20.56这个虚拟的位置点对应的像素值估计出来。如下图所示，蓝色的虚线框表示卷积后获得的feature map，黑色实线框表示ROI feature，最后需要输出的大小是2x2，那么我们就利用双线性插值来估计这些蓝点（虚拟坐标点，又称双线性插值的网格点）处所对应的像素值，最后得到相应的输出。这些蓝点是2x2Cell中的随机采样的普通点，作者指出，这些采样点的个数和位置不会对性能产生很大的影响，你也可以用其它的方法获得。然后在每一个橘红色的区域里面进行max pooling或者average pooling操作，获得最终2x2的输出结果。我们的整个过程中没有用到量化操作，没有引入误差，即原图中的像素和feature map中的像素是完全对齐的，没有偏差，这不仅会提高检测的精度，同时也会有利于实例分割。这么细心，做科研就应该关注细节，细节决定成败。

![img](https://i.loli.net/2020/07/25/ENsRKcdnHLhgpzo.jpg)

## 双线性插值

- 概念

双线性插值(bilinear interpolation)，又称为双线性内插。在数学上，双线性插值是有两个变量的插值函数的线性插值扩展，其核心思想是在两个方向分别进行一次线性插值。在数字图像和音频处理领域都有应用。

在图像处理中，双线性插值法**考虑围绕未知像素的计算位置的** **最近邻域的已知像素**。然后对这4个像素进行加权平均，以得出其最终的内插值。

- 公式推导

如图，已知求位置像素P的像素值， 已知相邻 的像素区域对应位置和像素值，其中坐下角像素区域标号为11，左上角像素区域标号为12，右下角像素区域标号为21，右上角像素区域标号为22。

<img src="https://s2.loli.net/2024/08/06/4ZCkwPDdm1vxilW.png" alt="image.png" style="zoom:50%;" />

​	注意分别$Q_{11}=(x_1,y_1)，Q_{12}=(x_1,y_2)，Q_{21}=(x_2,y_1)，Q_{22}=(x_2,y_2)$对应**像素单元（区域）的中心点**。

线性插值的计算公式描述：已知直线上两点$y_1=\phi(x_1,y_1)$，$y_2=\phi(x_2,y_2)$，求直线上任意一点$(x,y)$的值$\phi(x,y)$。
$$
\phi(x,y)=\frac{x-x_1}{x_2-x_1}y_2+\frac{x-x_2}{x_1-x_2}y_1
$$
==第一步==，利用上式执行两次线性插值操作：使用$Q_{11}$和$Q_{21}$计算$R_1=(x,y_1)$的点的像素值大小；使用$Q_{12}$和$Q_{22}$计算$R_2=(x,y_2)$点像素值大小。
$$
\phi(x,y_1)=\frac{x-x_1}{x_2-x_1}\phi(x_2,y_1)+\frac{x-x_2}{x_1-x_2}\phi(x_1,y_1)
$$

$$
\phi(x,y_2)=\frac{x-x_1}{x_2-x_1}\phi(x_2,y_2)+\frac{x-x_2}{x_1-x_2}\phi(x_1,y_2)
$$

==第二步==，利用上述两个公式得到的结果，再执行一次线性插值，得到目标位置$P$的像素值。
$$
\phi(x,y)=\frac{y-y_1}{y_2-y_1}\phi(x,y_2)+\frac{y-y_2}{y_1-y_2}\phi(x,y_1)\\
=\frac{y-y_1}{y_2-y_1}(\frac{x-x_1}{x_2-x_1}\phi(x_2,y_2)+\frac{x-x_2}{x_1-x_2}\phi(x_1,y_2))+\frac{y-y_2}{y_1-y_2}(\frac{x-x_1}{x_2-x_1}\phi(x_2,y_1)+\frac{x-x_2}{x_1-x_2}\phi(x_1,y_1))\\
=\frac{1}{(y_2-y_1)(x_2-x_1)}((x-x_1)(y-y_1)\phi(x_2,y_2)+(x-x_2)(y-y_1)\phi(x_1,y_2)+(x-x_1)(y-y_2)\phi(x_2,y_1)+(x-x_1)(y-y_1)\phi(x_1,y_1))
$$
由于 $Q_{11}$,$Q_{12}$ ,$Q_{21}$ ,$Q_{22}$ 分别为相邻像素的中间位置坐标，如下图所示。

<img src="https://s2.loli.net/2024/08/06/2YoSsB6NFZ5Pxgr.png" alt="image.png" style="zoom:50%;" />

​	容易得到$y_2-y_1=1$，$x_2-x_1=1$，因此双线性插值公式还能简化为:
$$
\phi(x,y)=(x-x_1)(y-y_1)\phi(x_2,y_2)+(x-x_2)(y-y_1)\phi(x_1,y_2)+\\(x-x_1)(y-y_2)\phi(x_2,y_1)+(x-x_1)(y-y_1)\phi(x_2,y_2)
$$
​	同理容易得到：
$$
(x-x_1)(y-y_1)+(x-x_2)(y-y_1)+(x-x_1)(y-y_2)+(x-x_1)(y-y_1)=1
$$
​	$\phi(x,y)$还能进一步表示为：
$$
\phi(x,y)=\Sigma_{i,j=1}^{2}\phi(x_i,y_i)max(0,1-|x-x_i|)max(0,1-|y-x_i|)
$$

- 公式物理意义

  <img src="https://s2.loli.net/2024/08/06/1hTCwrUHtNdK5Zj.png" alt="image.png" style="zoom:33%;" />

  通过上式可以看出， 双线性插值本质上是目标像素值相邻四个像素的像素值加权和值。

  对于第一项$(x-x_1)(y-y_1)\phi(x_2,y_2)$表示右上角像素$\phi(x_2,y_2)$的像素值加权后的结果，其对应的权重公式 ，可以看出第一项权重$(x-x_1)(y-y_1)$本质上是目标像素$\phi(x_2,y_2)$对应的对角像素$\phi(x_1,y_1)$所构成的矩形区域的面积大小，如上图紫色区域。同理其它三项也满足同样的规律。

  **当目标元素与某个相邻元素的距离越近，目标元素元素与该相邻像素的对角像素组成的矩形框面积大小就越大，该相邻像素对应的权重值就越大。**

  综上可以得到， **双线性插值本质上是目标像素所相邻的四个像素， 分别以像素对应的对角像素与目标像素的构成的矩形区域为权重，像素大小为值的加权和**。

  

## 参考资料

[Mask R-CNN详解](https://blog.csdn.net/WZZ18191171661/article/details/79453780)

[Roi Pooling 和Roi Align有何区别？](https://mp.weixin.qq.com/s?__biz=MzU0NjgzMDIxMQ==&mid=2247579406&idx=5&sn=0da15e076be89b3f8a822abd16ae8aef&chksm=fb5455e2cc23dcf4b753e5d20c35415ef62712c04bf9ce4f77f7cb678b65bddf0f7a5c3c955b&scene=27)